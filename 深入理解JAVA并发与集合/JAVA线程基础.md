- [JAVA线程基础](#JAVA线程基础])
  - [进程与线程](#进程与线程)

# JAVA线程基础

> 我重新规划了这篇文章的内容，之前的标题是“JAVA线程”，现在多了“基础”二字。在看了《JAVA并发编程之美》后，个人同意将线程的基础概念作为第一章节介绍很有必要

> 并发中一个经典的问题是：进程与线程的区别是什么。这个问题虽然是老生常谈了，但一千个回答者就会有一千种答案，资历不同的人回答得深度和感受也是不一样的，比如“只是会背概念”、“实战过JAVA多线程程序，从实战中理解”、“接触过CPU底层调试，从汇编层理解”这三种层次，阅历深的面试官是可以看出来你在什么层次，这也是该问题时常作为并发面试问题首选的原因

> 围绕线程展开的基础知识有很多，比如：进程&线程的区别，线程创建和运行的多种方式，JAVA线程生命周期&JAVA对象&monitor对象，线程死锁，ThreadLocal，synchronized&volatile关键字，CAS等等，其中有一些概念是值得拓展的，比如synchonized锁升级优化，volatile=>JAVA内存模型，CAS=>AQS等，有必要的，我会在其他章节进行展开

> 上面所述的基础知识就是本章的核心点

### 进程与线程

基础篇，也从这个老生常谈的问题开始：进程&线程的区别是什么？

我们不妨先来看一下定义，搜索了一下维基百科，得到如下

> In computing, a process is the instance of a computer program that is being executed by one or many threads. It contains the program code and its activity.

> In computer science, a thread of execution is the smallest sequence of programmed instructions that can be managed independently by a scheduler. In most cases a thread is a component of a process.

上面提到了几点，一是进程是代码在数据集合上的一次运行活动，二是线程是程序执行的最小单位，三是一个进程可能包含多个线程

光从定义来看，似乎还不够透彻，因此在搜索了多方资料后，我得到如下总结
- 进程，直观点说，保存在硬盘上的程序运行以后，会在内存空间里形成一个独立的内存体，这个内存体有自己独立的地址空间，有自己的堆，上级挂靠单位是操作系统。操作系统会以进程为单位，分配系统资源（CPU时间片、内存等资源），进程是代码在数据集合上的一次运行活动，进程是操作系统资源分配的最小单位
- 线程，有时被称为轻量级进程（Lightweight Process，LWP），线程是进程中的一个实体，线程本身是不会独立存在的。操作系统在分配资源时是把资源分配给进程的，但是CPU资源比较特殊，它是被分配到线程的，真正占用CPU运行的是线程，线程是CPU调度与执行的最小单位
- 程序计数器是一块线程私有的内存区域，用于记录线程执行程序地址，它被设计为私有的，原因是线程是CPU调度与执行的基本单位，而CPU一般是使用时间片轮转方式让线程轮询占用的，所以当线程CPU时间片用完后，要让出CPU，等下次轮到自己的时候再执行，所以需要一块内存地址保存上一次的执行地址

这里有几个关键点
- **（一）进程——操作系统资源分配最小单位**
- **（二）线程（轻量级进程）——CPU调度与执行的最小单位**
- **（三）CPU时间片轮询方法执行每个进程的线程 => 程序计数器保存上一次线程执行地址**

从这里我们可以画出一幅图来加强理解与记忆

![image](https://user-images.githubusercontent.com/10209135/97282506-b57e6100-1879-11eb-98f6-e9d396af54ce.png)

进程与线程的区别及联系

【区别】
- 调度：线程作为调度和分配的基本单位，进程作为拥有资源的基本单位
- 并发性：不仅进程之间可以并发执行，同一个进程的多个线程之间也可并发执行
- 拥有资源：进程是拥有资源的一个独立单位，线程不拥有系统资源，但可以访问隶属于进程的资源。进程所维护的是程序所包含的资源（静态资源）， 如：地址空间，打开的文件句柄集，文件系统状态，信号处理handler等；线程所维护的运行相关的资源（动态资源），如：运行栈，调度相关的控制信息，待处理的信号集等
- 系统开销：在创建或撤消进程时，由于系统都要为之分配和回收资源，导致系统的开销明显大于创建或撤消线程时的开销。但是进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，一个进程死掉就等于所有的线程死掉，所以多进程的程序要比多线程的程序健壮，但在进程切换时，耗费资源较大，效率要差一些

【联系】
- 一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程
- 资源分配给进程，同一进程的所有线程共享该进程的所有资源
- 处理机分给线程，即真正在处理机上运行的是线程
- 线程在执行过程中，需要协作同步，不同进程的线程间要利用消息通信的办法实现同步

> 写到这里，关于进程与线程的基本概念就说完了，对于JAVA业务程序员来说，能把上面理解其实已经足够了。然而，如果你要“打破砂锅问到底”的话，再往下深入想，可能会总感觉进程与线程的概念还是比较抽象，没有形成具象的印象，这个时候就需要去研究一下CPU的工作原理了，仔细揣摩CPU时间片到底是如何运行的。关于思考出的问题，我举一些例子。既然进程是资源分配的最小单位，那么每个进程都分配了独立的时间片，可是在并发与并行（下文会有）的概念中，单核CPU可以并发但不可以并行，只有多核CPU可以并行，既然如此的话，是否一个核中的多个进程，时间片轮序顺序也是序列化的呢（一个进程抢占了时间片，其他进程必须等待）？还有，线程与线程之间是共享资源的，利用消息通信实现同步，这里的消息通信具体是指什么方式？进程与进程之间又是通过什么方法来通信的？诸如此类的问题，只要你深想，就会出来，要去真正的理解，需要往CPU层原理上去学，这一块不是本篇文章的重点，因此不会全部包含

### 并发与并行

