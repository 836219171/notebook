- [类文件结构](#类文件结构)

# 类文件结构

> 终于开始类文件结构章节的书写了，为了写这一篇章节，我花了至少7天的时间完成了一个ParseClassFile项目，项目链接：https://github.com/peteryuanpan/ParseClassFile 。刚刚写完了这个项目的介绍文档，它的核心功能，是读入一份类文件，将每一个字节的含义按照特有的格式输出。对该项目感兴趣的朋友，可以进去看看文档和源码，我也非常建议结合两份文档一起来阅读，单独阅读本文章肯定是枯燥乏味的，解析类文件过程就是这样，无法避免

> 我将会在文章中以类文件为具体例子，介绍类文件的组成部分，还会穿插JavaSE中的基础问题、面试问题等

> 在准备的过程中，我发现一个点，解析类文件结构，实际上是对JAVA语法更深入的理解，比如try catch语句、throws Exception语句，它们对应类文件的哪一个部分，具体内容是什么，比如float和double分别是4个字节和8个字节，但表示的数字范围很大，浮点表示法的原理是什么，比如一个方法完整有哪些组成部分等等。所以，在书写文章的过程中，我不仅会逐一介绍类文件结构的组成部分，还会穿插着JavaSE中的基础问题、面试问题

> 多提一点，这里并不涉及到字节码指令（非指Java字节码），字节码指令只是方法表中的一个属性Attribute_Code而已，关于字节码我们会在 [字节码指令](字节码指令.md) 章节中讲解

> 需要说清楚一点，Java bytecode直译是Java字节码，但我认为不准确，更准确的翻译是二进制字节流。JAVA虚拟机定义是一种能够运行Java字节码的文件，这里的Java字节码是广义的指二进制字节流，而狭义的是指字节码指令。二进制字节流包括类文件，虚拟机加载的一般是类文件，不是只加载字节码指令（比如new、putstatic、getstatic这些指令）。字节码指令是指描述Java语句的指令，主要存在于方法表中，它只是类文件的一部分

### 类文件的定义

类文件是一种可以被虚拟机执行的包含了字节码数据的文件；Java类文件通常被Javac编译器从JAVA源文件编译而来，同时，其他语言也可以编译成类文件，比如Jython，Scala，Kotlin

> A Java class file is a file (with the .class filename extension) containing Java bytecode that can be executed on the Java Virtual Machine (JVM). A Java class file is usually produced by a Java compiler from Java programming language source files (.java files) containing Java classes (alternatively, other JVM languages can also be used to create class files).

在类加载这一章节中，我们已经说的比较清楚了，类文件无关乎从哪个语言而来，无关乎在哪里存储，准确的说，它是一组二进制字节流

### 类文件结构的轮廓

类文件结构的轮廓（Layout）有16个元素，分别如下

|序号|类型|名称|数量|
|--|--|--|--|
|1|U4|magic|1|
|2|U2|minor_version|1|
|3|U2|major_version|1|
|4|U2|costant_pool_count|1|
|5|cp_info|costant_pool|costant_pool_count - 1|
|6|U2|access_flags|1|
|7|U2|this_class|1|
|8|U2|super_class|1|
|9|U2|interfaces_count|1|
|10|U2|interfaces|interfaces_count|
|11|U2|fields_count|1|
|12|field_info|field|fields_count|
|13|U2|methods_count|1|
|14|method_info|method|methods_count|
|15|U2|attributes_count|1|
|16|attribute_info|attributes|attributes_count|

其中类型中含有U1、U2、U4、U8四种，它们是无符号数，除了无符号数外，剩下都称之为表，表是一种复合型数据类型

可以看出，类文件结构轮廓中有4项属于表，分别是constant_pool、fields、methods、attributes，其他都是无符号数

### 无符号数与表

无符号数属于基本的数据类型，以U1、U2、U4、U8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数

无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成的字符串值

### 魔数

每个Class文件的头4个字节称为魔数（magic，第1项），它的唯一作用是确定这个文件是否为一个能被虚拟机接收的Class文件

很多文件存储标准中都使用魔数来进行身份识别，不如gif、jpeg文件头中都有魔数

Class文件的魔数很具有“浪漫气息”，值为：0xCAFEBABE，经常被戏称为“咖啡宝贝”

> 这个魔数值在Java还称作“Oak”语言时（大概1991年前后）就已经确定了，据说是为了象征著名咖啡品牌Peet's Coffee中深受欢迎的Baristas咖啡而起的

我们来以一段最简单的Java程序为例子，命名

VerySimpleClassFile.java
```java
package classfile;

public class VerySimpleClassFile {
}
```

这个Java程序够简单了吧，表面看上去它几乎什么都没有，就一个package和class信息

它class文件如下

```
cafe babe 0000 0034 000d 0a00 0300 0a07
000b 0700 0c01 0006 3c69 6e69 743e 0100
0328 2956 0100 0443 6f64 6501 000f 4c69
6e65 4e75 6d62 6572 5461 626c 6501 000a
536f 7572 6365 4669 6c65 0100 1856 6572
7953 696d 706c 6543 6c61 7373 4669 6c65
2e6a 6176 610c 0004 0005 0100 1d63 6c61
7373 6669 6c65 2f56 6572 7953 696d 706c
6543 6c61 7373 4669 6c65 0100 106a 6176
612f 6c61 6e67 2f4f 626a 6563 7400 2100
0200 0300 0000 0000 0100 0100 0400 0500
0100 0600 0000 1d00 0100 0100 0000 052a
b700 01b1 0000 0001 0007 0000 0006 0001
0000 0003 0001 0008 0000 0002 0009 
```

VerySimpleClassFile.java中还包含了12个（4种）常量池项，1个方法，1个属性，我们后面在讲到常量池等时，可能会引用到这份文件

可以看到，class文件开头8个字符是cafebabe，每一个字符表示1个十六进制数（0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f）

1个十六进制数可以由4位二进制数表示，8位是1字节，因此2个十六进制数是1个字节

那么8个十六进制数就是4个字节，魔数（magic）也是一个U4类型，表示4个字节的无符号数

### 版本号

版本号有两个项，分别是次版本号（minor_version，第2项）和主版本号（major_version，第3项）

它们对应十六进制数分别是 0000 和 0034，转成十进制数分别是 0 和 52

下面是JDK版本号与主次版本号的对应表格

|JDK版本|十六进制版本号|十进制版本号|
|--|--|--|
|JDK6|00000032|50.0|
|JDK7|00000033|51.0|
|JDK8|00000034|52.0|
|JDK9|00000035|53.0|
|JDK10|00000036|54.0|
|JDK11|00000037|55.0|
|JDK12|00000038|56.0|
|JDK13|00000039|57.0|

高版本的JDK能向下兼容以前版本的Class文件，但不能运行以后版本的Class文件，虚拟机必须拒绝执行超过其版本号的Class文件

### 常量池

> 好，到了第一个比较复杂的项目了，常量池中的类型比较多，JDK8种就有17种，我将会尽量把每一种常量池都举一个例子，来解释它

#### 常量池的定义

常量池是存放常量数据的主要仓库，两大类常量：字面量（Literal）和符号引用（Symbolic References）

字面量比较接近Java语言层面的常量概念，如文本字符串、声明为final的常量值等

符号引用则属于编译原理方面的概念，包括下面三类常量
- 类和接口的全限定名（Fully Qualified Name）
- 字段的名称和描述符（Descriptor）
- 方法的名称和描述符

Java代码在进行Javac编译时，并不像C和C++那样有“连接”这一步，而是在虚拟机加载Class文件的进行动态链接

当虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建时（静态解析）或运行时（动态链接）解析、翻译到具体的内存地址中

#### 常量池容量计数器

常量池容量计数器（costant_pool_count，第4项）表示常量池的个数减1

这里指的特殊说明的一点是，常量池的索引范围是[1, costant_pool_count)

至于为什么是这样子，并不清楚，总之现在就是这么定义的了

举例子来说，假设costant_pool_count=20，那么索引1表示第一个常量池，索引19表示最后一个常量池

也就是说，实际的常量池个数要少1个，costant_pool_count=20，则有19个常量池

从索引1开始只有常量池是特殊的，其他的数组类型，包括接口集合、字段表集合、方法表集合等，索引都是从0开始

索引在类文件的数组类型中，是非常重要的，因为时常会涉及到数组元素的指是一个索引，指向的是数组的另一个元素，下面的例子中会有具体体现

#### 常量池结构的轮廓

截止JDK8，常量池中一共有17种常量，分别如下

|类型|标志|描述|
|--|--|--|
|CONSTANT_Utf8_info|1||
|CONSTANT_Integer_info|3||
|CONSTANT_Float_info|4||
|CONSTANT_Long_info|5||
|CONSTANT_Double_info|6||
|CONSTANT_Class_info|7||
|CONSTANT_String_info|8||
|CONSTANT_Fieldref_info|9||
|CONSTANT_Methodref_info|10||
|CONSTANT_InterfaceMethodref_info|11||
|CONSTANT_NameAndType_info|12||
|CONSTANT_MethodHandle_info|15||
|CONSTANT_MethodType_info|16||
|CONSTANT_Dynamic_info|17||
|CONSTANT_InvokeDynamic_info|18||
|CONSTANT_Module_info|19||
|CONSTANT_Package_info|20||

#### 

### 访问标志

### 本类父类接口

### 字段表

### 方法表

### 属性表
