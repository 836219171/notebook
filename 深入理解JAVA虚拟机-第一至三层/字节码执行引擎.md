- [字节码执行引擎](#字节码执行引擎)
  - [字节码执行引擎的定义](#字节码执行引擎的定义)
  - [虚拟机栈与本地方法栈](#虚拟机栈与本地方法栈)
  - [类加载与方法运行](#类加载与方法运行)
  - [运行时栈帧结构](#运行时栈帧结构)

# 字节码执行引擎

> 这一章原来的标题是 字节码执行引擎与即时编译器，原本计划是拆成两章来写的，在《深入理解JAVA虚拟机》第二版中，就拆成了三章来写，分别是第8章字节码执行引擎、第10章早期（编译期）优化、第11章晚期（运行期）优化。标题只包含字节码执行引擎，是认为即时编译器概念不属于核心章节了，作为了解即可。中途我还考虑过要不要以“虚拟机半编译半解释执行”来命标题，后来还是改回了“字节码执行引擎”，理由是，我认为这一章应该更强调栈帧、方法调用与执行的概念

> 早期的时候虚拟机是只有解释执行的，由字节码执行引擎完成，而即时编译技术是后期发展出来的，通过对热点代码，将字节码直接编译成机器码而运行，大大提高了虚拟机运行效率

> 个人认为，这一章的核心思想有两点：一，理解JAVA是一个半编译半解释型的语言；二，理解方法在虚拟机中运行的逻辑。把这两点把握好，就足够了

### 字节码执行引擎的定义

字节码执行引擎是用于执行Java字节码的引擎工具，Java字节码是用于描述方法语句的，因此字节码执行引擎也是虚拟机方法调用和方法执行的工具

执行引擎是Java虚拟机最核心的组成部分之一。“虚拟机”是一个相对于“物理机”的概念，这两种机器都有代码执行能力，其区别是物理机的执行引擎是直接建立在处理器、硬件、指令集和操作系统层面上的，而虚拟机的执行引擎则是由自己实现的，因此可以自行制定指令集与执行引擎的而结构体系，并且能够执行那些不被硬件支持的指令集格式

### 虚拟机栈与本地方法栈

在谈方法调用与方法执行前，先要谈一谈栈帧，在谈栈帧之前，先要谈一谈虚拟机栈和本地方法栈

在[运行时数据区域-虚拟机栈与本地方法栈](运行时数据区域.md#虚拟机栈与本地方法栈)中，有提及相关概念，这里复习一下
- 虚拟机栈与本地方法栈描述的是Java方法调用与执行的内存模型
- 虚拟机栈是线程私有的，每个线程都有一个虚拟机栈
- 本地方法栈与虚拟机栈二者内部结构是一样的，本地方法栈为native方法服务（JNI），虚拟机栈为非native方法服务
- 栈帧是虚拟机栈的基本元素，用于支持虚拟机栈进行方法调用和方法执行的数据结构
- 每个方法从调用到执行完成的过程，都对应着一个栈帧在虚拟机栈中从入栈到出栈的过程，即一个栈帧对应着一次方法调用执行

JVM内存中，运行时数据区主要是虚拟机栈和堆两个部分（当然还有别的部分），这两个部分，虚拟机栈用于管理每个线程的方法，堆用于管理对象

### 类加载与方法运行

虚拟机在启动后，会先执行类加载，将类文件信息读入内存，并转换成运行时类的元信息，存入方法区，这是准备过程

类加载中，会加载main方法所在的类（称为Main类），然后执行public static main(String[] args)方法

来看下openjdk8源码：https://github.com/peteryuanpan/openjdk-8u40-source-code-mirror/blob/master/jdk/src/share/bin/java.c#L444
```cpp
int JNICALL
JavaMain(void * _args)
{
...
/*
     * Get the application's main class.
     ...
*/
    mainClass = LoadMainClass(env, mode, what);
..
    mainID = (*env)->GetStaticMethodID(env, mainClass, "main",
                                       "([Ljava/lang/String;)V");
...
    (*env)->CallStaticVoidMethod(env, mainClass, mainID, mainArgs);
```

从源码中解释了加载Main类（LoadMainClass）和运行main方法（GetStaticMethodID、CallStaticVoidMethod）的两个过程

在执行main方法过程中，会遇到许多类型的字节码指令，字节码执行引擎会根据其含义在底层创建数据结构，执行对应算法去执行

字节码指令中，有几个是用于调用方法的
- invokevirtual：调用实例方法
- invokespecial：调用超类构造方法、实例初始化方法、私有方法、父类方法
- invokestatic：调用静态方法
- invokeinterface：调用接口方法
- invokedynamic：调用动态方法

字节码执行引擎在遇到上面几个字节码指令后，就会创建一个栈帧，存入虚拟机栈中，然后执行对应方法的字节码指令，在执行完成后，会从虚拟机栈中将栈帧弹出

上面就是从类加载到main方法执行到其它方法执行的一个过程诠释，是可以比较直观的解释栈帧在程序运行中的作用

### 运行时栈帧结构

![image](http://tswork.peterpy.cn/java_runtime.png)


### 局部变量表
#### 局部变量表的定义
#### 最小单位Slot
#### this指针

### 操作数栈
#### 操作数栈的定义
#### 操作数栈与Code属性

### 动态链接
#### 动态链接的定义
#### 动态链接与静态解析

### 返回地址
#### 返回地址的定义
#### 保存现场与恢复现场

### 方法调用
#### 静态分配
#### 动态分派
#### invokedynamic

### 方法执行
#### 解释模式
#### 编译模式
#### 混合模式

### 即时编译
#### 即时编译器
#### 即时编译触发条件
#### 热点代码区
#### 优化技术概览

### JAVA是半编译半解释型语言

### 逃逸分析
#### 栈上分配
#### 同步消除
#### 标量替换
